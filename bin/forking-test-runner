#!/usr/bin/env ruby

# enable local usage from cloned repo
root = File.expand_path("../..", __FILE__)
$LOAD_PATH << "#{root}/lib" if File.exist?("#{root}/Gemfile")

require 'forking_test_runner'

ForkingTestRunner.disable_minitest_autorun

runtime_log = ForkingTestRunner.delete_argv("--runtime-log", ARGV)
helper = ForkingTestRunner.delete_argv("--helper", ARGV) || "test/test_helper"

require "./#{helper}"

tests = ForkingTestRunner.find_tests_for_group(ARGV, runtime_log)
puts "Running tests #{tests.map(&:first).join(" ")}"

show_time = tests[0][1]

clear = "------"
results = tests.map do |file, expected|
  puts "#{clear} >>> #{file}"
  success = false
  time = Benchmark.realtime do
    success = ForkingTestRunner.run_test(file)
  end
  puts "Time: expected #{expected.round(2)}, actual #{time.round(2)}" if show_time
  puts "#{clear} <<< #{file} ---- #{success ? "OK" : "Failed"}"
  [file, time, expected, success]
end

puts "\nResults:"
puts results.map { |f,_,_,r| "#{f}: #{r ? "OK" : "Fail"}"}

if show_time
  puts "Time: #{results.map { |_,time,expected,_| time - expected }.inject(:+).to_f.round(2)} diff to expected"
end

# log runtime and then curl it into the runtime log location
if ENV["RECORD_RUNTIME"]
  require 'tempfile'
  slug = ENV.fetch("TRAVIS_REPO_SLUG").sub("/", "-")
  id = ENV.fetch("TRAVIS_BUILD_NUMBER")
  url = "https://amend.herokuapp.com/amend/#{slug}-#{id}"
  data = results.map { |f,time,_,_| "#{f}:#{time.round(2)}" }.join("\n") << "\n"
  Tempfile.open("runtime.log") do |f|
    f.write(data)
    f.close
    result = `curl -X POST --data-binary @#{f.path} #{url}`
    puts "amended runtime log\ncurl #{url} | sort > #{runtime_log}\nStatus: #{$?.success?}\nResponse: #{result}"
  end
end

exit(results.map(&:last).all? ? 0 : 1)
